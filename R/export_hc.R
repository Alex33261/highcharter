#' Function to export js file the configuration options
#' @param hc A \code{highcarts object}.
#' @param filename String of the exported file.
#' @param as String to define how to save the configuration options.
#'   One of 'is', 'container', 'variable'.
#' @param name A variable used to put as name of the generated object if \code{as} is
#' \code{'variable'} and the css/js selector if is \code{as} is container.
#' 
#' @examples 
#' 
#' fn <- "function(){
#'   console.log('Category: ' + this.category);
#'   alert('Category: ' + this.category);
#' }"
#' 
#' hc <- highcharts_demo() %>% 
#'   hc_plotOptions(
#'     series = list(
#'       cursor = "pointer",
#'         point = list(
#'           events = list(
#'             click = JS(fn)
#'          )
#'        )
#'    )
#'  )
#' 
#' export_hc(hc, filename = "~/hc_is.js", as = "is")
#' export_hc(hc, filename = "~/hc_vr.js", as = "variable", name = "objectname")
#' export_hc(hc, filename = "~/hc_ct.js", as = "container", name = "#selectorid")
#' 
#' @importFrom jsonlite toJSON
#' @importFrom stringr str_split str_c str_detect str_replace
#' @importFrom utils head
#' @export 
export_hc <- function(hc, filename = NULL, as = "is", name = NULL) {
  
  # filename <- "~/tets.js"
  # load("~/hc.Rdata")
  
  stopifnot(!is.null(filename))
  
  if (!str_detect(filename, ".js$"))
    filename <- str_c(filename, ".js")

  jslns <- toJSON(hc$x$hc_opts, pretty = TRUE, auto_unbox = TRUE,
                  force = TRUE, null = "null", na = "null") 
  
  jslns <- unlist(str_split(jslns, "\n"))
  
  # remove quotes from elements
  jslns <- jslns %>% 
    str_replace('"', "") %>% 
    str_replace("\":", ":")
  
  # function thing 
  fflag <- str_detect(jslns, "function")
  
  if (any(fflag)) {
    
    # remove 1st quote
    jslns <- ifelse(fflag, str_replace(jslns, "\"function", "function"), jslns)
    
    # remove last quote
    jslns <- ifelse(fflag, str_replace(jslns, "\",$", ","), jslns)
    jslns <- ifelse(fflag, str_replace(jslns, "\"$", ""), jslns)
    
    # fix eol for functions with more than 1 line
    jslns <- unlist(str_split(jslns, "\\\\n"))
  }

  tmpl <- switch(
    as,
    is = "%s",
    container = sprintf("$(function(){\n\t$('%s').highcharts(\n%%s\n);\n});", name),
    variable = sprintf("%s = %%s", name)
  )

  jslns <- str_c(jslns, collapse = "\n")
  jslns <- sprintf(tmpl, jslns)
  
  # this try to pretty export_hc(hchart(AirPassengers))
  # jslns <- str_replace_all(jslns, "\n\\s{4,}\\]\\,\n\\s{4,}\\[\n\\s{4,}", "],[")
  
  mssg <- sprintf("// Generated by highcharter %s", Sys.time())
  jslns <- str_c(c(mssg, jslns), collapse = "\n")
  
  if(getOption("highcharter.verbose"))
    message(sprintf("saving file in '%s'", filename))
  
  writeLines(jslns, filename)
  
}
